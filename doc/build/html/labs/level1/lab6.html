

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>A simple bootloader &mdash; ARC Labs 2018.09 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Advanced labs" href="../level2.html" />
    <link rel="prev" title="ARC features: Interrupts" href="lab4.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ARC Labs
          

          
          </a>

          
            
            
              <div class="version">
                2018.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../labs.html">Hands-on labs</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../level1.html">Basic labs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lab1.html">How to use ARC IDE</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab2.html">How to use embARC OSP</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab5.html">How to use ARC board</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab3.html">ARC features: AUX registers and timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab4.html">ARC features: Interrupts</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">A simple bootloader</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-bootloader">Simple Bootloader</a></li>
<li class="toctree-l4"><a class="reference internal" href="#content">Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#principles">Principles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../level2.html">Advanced labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../level3.html">Exploration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC Labs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../labs.html">Hands-on labs</a> &raquo;</li>
        
          <li><a href="../level1.html">Basic labs</a> &raquo;</li>
        
      <li>A simple bootloader</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/labs/level1/lab6.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="a-simple-bootloader">
<span id="lab6"></span><h1>A simple bootloader<a class="headerlink" href="#a-simple-bootloader" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Understand the memory map of ARC boards</li>
<li>Understand the principles of bootloader and self-booting</li>
<li>Understand the usage of shell commands in cmd</li>
<li>Create a self-booting application</li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The following hardware and tools are required:</p>
<ul class="simple">
<li>PC host</li>
<li>GNU Toolchain for ARC Processors / MetaWare Development Toolkit</li>
<li>ARC board (EM Starter Kit / IoT Development Kit)</li>
<li>SD card</li>
<li><code class="docutils literal notranslate"><span class="pre">example/baremetal/bootloader</span></code></li>
</ul>
</div>
<div class="section" id="simple-bootloader">
<h2>Simple Bootloader<a class="headerlink" href="#simple-bootloader" title="Permalink to this headline">¶</a></h2>
<p>This simple bootloader is designed to work as a secondary/simple bootloader
for embARC OSP, it loads <code class="docutils literal notranslate"><span class="pre">boot.hex</span></code> or <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code> on SD Card and run that program.
The example can be used as ntshell application.</p>
<p>The following features are provided in this simple bootloader:</p>
<ul class="simple">
<li>Boot application from SD card</li>
<li>File operations on SD card</li>
<li>UART Y-modem protocol to update application</li>
<li>Operations on ARC processors</li>
</ul>
</div>
<div class="section" id="content">
<h2>Content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Build and run the <code class="docutils literal notranslate"><span class="pre">example/baremetal/bootloader</span></code></li>
<li>Download the generated <code class="docutils literal notranslate"><span class="pre">bootloader.bin</span></code> into flash</li>
<li>Build a self-boot application and boot it from SD card</li>
<li>Use the ntshell commands</li>
</ol>
</div>
<div class="section" id="principles">
<h2>Principles<a class="headerlink" href="#principles" title="Permalink to this headline">¶</a></h2>
<div class="section" id="memory-map-of-arc-board">
<h3>Memory Map of ARC board<a class="headerlink" href="#memory-map-of-arc-board" title="Permalink to this headline">¶</a></h3>
<div class="section" id="emsk">
<h4>EM Starter Kit<a class="headerlink" href="#emsk" title="Permalink to this headline">¶</a></h4>
<p>The available memory regions of EM Starter Kit are shown below:</p>
<table border="1" class="colwidths-auto docutils" id="id5">
<caption><span class="caption-text">Memory Map of EM Starter Kit</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Start address</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>on-chip ICCM</td>
<td>0x00000000</td>
<td>256/128 KB</td>
</tr>
<tr class="row-odd"><td>on-chip DCCM</td>
<td>0x80000000</td>
<td>128 KB</td>
</tr>
<tr class="row-even"><td>on-board DDR RAM</td>
<td>0x10000000</td>
<td>128 MB</td>
</tr>
</tbody>
</table>
<p>In this lab, the last 1 MB of DDR (starting from 0x17f00000) is reserved for the
simple bootloader, other memory regions are available for application.</p>
</div>
<div class="section" id="iotdk">
<h4>IoT Development Kit<a class="headerlink" href="#iotdk" title="Permalink to this headline">¶</a></h4>
<p>The available memory regions of IoT Development Kit are shown in the following table:</p>
<table border="1" class="colwidths-auto docutils" id="id6">
<caption><span class="caption-text">Memory Map of IoT Development Kit</span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Start address</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>on-chip eflash</td>
<td>0x00000000</td>
<td>256 KB</td>
</tr>
<tr class="row-odd"><td>external boot SPI flash</td>
<td>0x10000000</td>
<td>2 MB</td>
</tr>
<tr class="row-even"><td>on-chip ICCM</td>
<td>0x20000000</td>
<td>256 KB</td>
</tr>
<tr class="row-odd"><td>on-chip SRAM</td>
<td>0x30000000</td>
<td>128 KB</td>
</tr>
<tr class="row-even"><td>on-chip DCCM</td>
<td>0x80000000</td>
<td>128 KB</td>
</tr>
<tr class="row-odd"><td>on-chip XCCM</td>
<td>0xC0000000</td>
<td>32 KB</td>
</tr>
<tr class="row-even"><td>on-chip YCCM</td>
<td>0xE0000000</td>
<td>32 KB</td>
</tr>
</tbody>
</table>
<p>In this lab, on-chip eflash and on-chip SRAM are reserved for the simple
bootloader, CCMs are reserved for application.</p>
</div>
</div>
<div class="section" id="boot-of-arc-board">
<h3>Boot of ARC board<a class="headerlink" href="#boot-of-arc-board" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>EM Starter Kit<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The EM Starter Kit uses a Xilinx SPARTAN-6 FPGA part which can be configured to run
different members of the ARCv2 EM Processor family. The EMSK includes a SPI
flash pre-programmed with four FPGA configurations of ARC EM cores.</p>
<p>When a “power on” or reset/configure is issued, the FPGA auto-loads one of
the pre-installed FPGA configurations from SPI flash. After the FPGA
configuration is loaded from the SPI flash, a simple primary bootloader is
loaded in ICCM. Through the primary bootloader, an application can be loaded
from SPI Flash into ICCM or external DDR memory.</p>
<p>Considering that the SPI Flash is used to store FPGA images, the secondary
bootloader is designed based on the primary bootloader to load an application
from an SD card since it can be read and written easily. The startup sequence
is listed below:</p>
<ol class="arabic simple">
<li>Power on or reset event.</li>
<li>Load FPGA configuration from the SPI flash.</li>
<li>Run primary bootloader, which loads the secondary bootloader from the SPI Flash into main memory (DDR).</li>
<li>Run secondary bootloader from main memory to load application from the SD card into ICCM/DDR memory.</li>
<li>Run the application from ICCM/DDR memory.</li>
</ol>
<img alt="Boot sequence of EMSK" src="../../_images/lab6_emsk_boot.png" />
</div>
<div class="section" id="id2">
<h4>IoT Development Kit<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>IoT Development Kit can boot from on-chip eflash and extern boot SPI flash, which is decided by
the FWU switch of IOTDK. When this switch is set to “off”, the processor
starts executing the program stored in on-chip eflash; When this switch is set
to “on”, the processor starts executing the program stored in external boot
SPI eflash. The simple bootloader can be written to both flash to load an application
from the TF card. The startup sequence for IoT Development Kit is listed below:</p>
<ol class="arabic simple">
<li>Power on or reset event</li>
<li>Boot from on-chip eflash or extern boot SPI flash decided by the FWU switch</li>
<li>Run simple bootloader to load application from the TF card into ICCM</li>
<li>Run the application from ICCM memory</li>
</ol>
</div>
</div>
<div class="section" id="how-to-flash-the-arc-board">
<h3>How to flash the ARC board<a class="headerlink" href="#how-to-flash-the-arc-board" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id3">
<h4>EM Starter Kit<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Generate a secondary bootloader binary file</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> &lt;embarc_root&gt;/example/baremetal/bootloader
<span class="gp">$</span> make <span class="nv">BOARD</span><span class="o">=</span>emsk <span class="nv">BD_VER</span><span class="o">=</span><span class="m">22</span> <span class="nv">CUR_CORE</span><span class="o">=</span>arcem7d <span class="nv">TOOLCHAIN</span><span class="o">=</span>gnu bin
</pre></div>
</div>
<ul>
<li><dl class="first docutils">
<dt>Program the secondary bootloader binary file into SPI Flash</dt>
<dd><ul class="first">
<li><p class="first">Insert SD card to your PC, and copy the binary file <code class="docutils literal notranslate"><span class="pre">obj_emsk_22/gnu_arcem7d/emsk_bootloader_gnu_arcem7d.bin</span></code> to SD card root folder, and rename it to <code class="docutils literal notranslate"><span class="pre">em7d_2bt.bin</span></code></p>
</li>
<li><p class="first">Insert the SD card to EMSK Board, choose the right core configuration, build and run the <code class="docutils literal notranslate"><span class="pre">&lt;embARC&gt;/example/baremetal/bootloader</span></code> example, then press any button to stop auto boot process, and enter to ntshell command mode</p>
</li>
<li><dl class="first docutils">
<dt>Use ntshell command <em>spirw</em> to program the <code class="docutils literal notranslate"><span class="pre">em7d_2bt.bin</span></code> into spiflash</dt>
<dd><ul class="first simple">
<li>Run <em>spirw</em> to show help</li>
<li>Run <em>spirw -i</em> to check SPI Flash ID, it should be <strong>Device ID = ef4018</strong></li>
<li>Run <em>spirw -w em7d_2bt.bin 0x17f00000 0x17f00004</em> to program spiflash</li>
<li>Check the output message to see if it has been programmed successfully</li>
</ul>
<img alt="../../_images/lab6_emsk_bootloader_program2spiflash.jpg" class="last" src="../../_images/lab6_emsk_bootloader_program2spiflash.jpg" />
</dd>
</dl>
</li>
<li><p class="first">If programmed successfully, when the board is reset, make sure Bit 4 of the on-board DIP switch is ON to enable secondary bootloader run</p>
</li>
<li><p class="first">If the SD card already contains the <em>boot.bin</em> in it, the bootloader automatically loads it from SD card. If not, it enters to ntshell mode</p>
</li>
<li><p class="first">You can goto the next step to generate the <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code> for proper application you want to be auto-loaded in SD card</p>
</li>
</ul>
<img alt="../../_images/lab6_emsk_bootloader_onspiflash.jpg" class="last" src="../../_images/lab6_emsk_bootloader_onspiflash.jpg" />
</dd>
</dl>
</li>
<li><p class="first">Generate <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code> using any embARC example, it’s RAM start address should be 0x10000000. Use bootloader to run it</p>
</li>
<li><dl class="first docutils">
<dt>Known Issues</dt>
<dd><ul class="first last simple">
<li>Boot rom of EMSK1.x is not able to load secondary bootloader on SPI Flash, you need a modified EMSK1.x mcs file to enable this function, send request in forum about this mcs file.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="id4">
<h4>IoT Development Kit<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Generate a secondary bootloader binary file</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> &lt;embarc_root&gt;/example/baremetal/bootloader
<span class="gp">$</span> gmake <span class="nv">BOARD</span><span class="o">=</span>iotdk <span class="nv">BD_VER</span><span class="o">=</span><span class="m">10</span> <span class="nv">CUR_CORE</span><span class="o">=</span>arcem9d <span class="nv">TOOLCHAIN</span><span class="o">=</span>mw <span class="nv">LOCATION</span><span class="o">=</span>eflash bin
</pre></div>
</div>
<ul>
<li><dl class="first docutils">
<dt>Program the secondary bootloader binary file into SPI Flash</dt>
<dd><ul class="first simple">
<li>Insert SD card to your PC, and copy the binary file <code class="docutils literal notranslate"><span class="pre">obj_iotdk_10/mw_arcem9d/simple_bootloader_mw_arcem9d.bin</span></code> to SD card Root, and rename it to <code class="docutils literal notranslate"><span class="pre">simple_bootloader.bin</span></code></li>
<li>copy the file <code class="docutils literal notranslate"><span class="pre">example/bootloader/boot.json</span></code> to SD card root, and change the boot_file value to <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code>, and change the ram_startaddress to 536870912(0x20000000)</li>
</ul>
<img alt="../../_images/lab6_iotdk_bootloader_bootjson.jpg" src="../../_images/lab6_iotdk_bootloader_bootjson.jpg" />
<ul class="simple">
<li>Insert the SD card to iotdk Board, build and run the <code class="docutils literal notranslate"><span class="pre">&lt;embARC&gt;/example/baremetal/bootloader</span></code> example, and enter to ntshell command mode</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> &lt;embarc_root&gt;/example/baremetal/bootloader
<span class="gp">$</span> gmake distclean
<span class="gp">$</span> gmake <span class="nv">BOARD</span><span class="o">=</span>iotdk <span class="nv">BD_VER</span><span class="o">=</span><span class="m">10</span> <span class="nv">CUR_CORE</span><span class="o">=</span>arcem9d <span class="nv">TOOLCHAIN</span><span class="o">=</span>mw run
</pre></div>
</div>
<ul>
<li><dl class="first docutils">
<dt>Use ntshell command <em>flash</em> to program the <code class="docutils literal notranslate"><span class="pre">simple_bootloader.bin</span></code> into both flash</dt>
<dd><ul class="first simple">
<li>Run <em>flash -h</em> to show help</li>
<li>Run <em>flash -eflsh simple_bootloader.bin</em> to program eflash</li>
<li>Run <em>flash -bootspi simple_bootloader.bin</em> to program bootspi flash</li>
<li>Check the output message to see if it was programmed successfully</li>
</ul>
<img alt="../../_images/lab6_iotdk_bootloader_program2spiflash.jpg" class="last" src="../../_images/lab6_iotdk_bootloader_program2spiflash.jpg" />
</dd>
</dl>
</li>
<li><p class="first">If the SD card already contains the <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code> and <code class="docutils literal notranslate"><span class="pre">boot.json</span></code> in it, the bootloader automatically loads it from SD card, if not, it enters to ntshell mode</p>
</li>
<li><p class="first">You can goto the next step to generate the <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code> for proper application you want to be auto-loaded in SD card</p>
</li>
</ul>
<img alt="../../_images/lab6_iotdk_bootloader_onspiflash.jpg" class="last" src="../../_images/lab6_iotdk_bootloader_onspiflash.jpg" />
</dd>
</dl>
</li>
<li><p class="first">Generate <code class="docutils literal notranslate"><span class="pre">boot.bin</span></code> using any embARC example, its RAM start address should be 0x20000000. Use bootloader to run it</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Create and build a different self-boot embARC application</li>
<li>Use the ntshell commands</li>
<li>Use the UART-ymodem to load your application</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../level2.html" class="btn btn-neutral float-right" title="Advanced labs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab4.html" class="btn btn-neutral" title="ARC features: Interrupts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Synopsys

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>