

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ARC features: Interrupts &mdash; ARC Labs 2018.09 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="A simple bootloader" href="lab6.html" />
    <link rel="prev" title="ARC features: AUX registers and timers" href="lab3.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ARC Labs
          

          
          </a>

          
            
            
              <div class="version">
                2018.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../labs.html">Hands-on labs</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../level1.html">Basic labs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lab1.html">How to use ARC IDE</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab2.html">How to use embARC OSP</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab5.html">How to use ARC board</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab3.html">ARC features: AUX registers and timers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ARC features: Interrupts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#equipment">Equipment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#content">Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#principles">Principles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps">Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lab6.html">A simple bootloader</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../level2.html">Advanced labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../level3.html">Exploration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC Labs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../labs.html">Hands-on labs</a> &raquo;</li>
        
          <li><a href="../level1.html">Basic labs</a> &raquo;</li>
        
      <li>ARC features: Interrupts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/labs/level1/lab4.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arc-features-interrupts">
<span id="lab4"></span><h1>ARC features: Interrupts<a class="headerlink" href="#arc-features-interrupts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>To introduce the interrupt handling of DesignWare® ARC® processors</li>
<li>To know how to use the interrupt and timer APIs already defined in embARC OSP</li>
</ul>
</div>
<div class="section" id="equipment">
<h2>Equipment<a class="headerlink" href="#equipment" title="Permalink to this headline">¶</a></h2>
<p>The following hardware and tools are required:</p>
<ul class="simple">
<li>PC host</li>
<li>GNU Toolchain for ARC Processors / MetaWare Development Toolkit</li>
<li>ARC board (EM Starter Kit / IoT Development Kit)</li>
<li><code class="docutils literal notranslate"><span class="pre">embarc_osp/arc_labs/labs/lab4_interrupt</span></code></li>
</ul>
</div>
<div class="section" id="content">
<h2>Content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Through <code class="docutils literal notranslate"><span class="pre">embarc_osp/arc_labs/labs/lab4_interrupt/part1</span></code> to learn the basics of interrupt handling of DesignWare® ARC® processors and the interrupt API provided by embARC OSP</li>
<li>Through <code class="docutils literal notranslate"><span class="pre">embarc_osp/arc_labs/labs/lab4_interrupt/part2</span></code> to learn the interrupt priority and interrupt nesting of DesignWare® ARC® processors and corresponding API of embARC OSP</li>
</ul>
</div>
<div class="section" id="principles">
<h2>Principles<a class="headerlink" href="#principles" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Interrupt</li>
</ol>
<p>An interrupt is a mechanism in processor to respond to special interrupt signals emitted by hardware or software. Interrupts can be used for processor to perform a specific function after some specific event happens and then return to its normal operation. For this purpose there are many different types of interrupts possible to be issued by hardware and software and each interrupt can have its own function called Interrupt Service Routine (ISR). ISR is a function (sequence of commands) to deal with the immediate event generated by a given interrupt.</p>
<ol class="arabic simple" start="2">
<li>Interrupt unit of DesignWare® ARC® processors</li>
</ol>
<p>The interrupt unit of DesignWare® ARC® processors has 16 allocated exceptions associated with vectors 0
to 15 and 240 interrupts associated with vectors 16 to 255.  The ARCv2 interrupt unit
is highly programmable and supports the following interrupt types:</p>
<ul class="simple">
<li>Timer — triggered by one of the optional extension timers and watchdog timer</li>
<li>Multi-core interrupts —triggered by one of the cores in a multi-core system</li>
<li>External — available as input pins to the core</li>
<li>Software-only — triggered by software only</li>
</ul>
<p>The interrupt unit of DesignWare® ARC® processors has the following interrupt specifications:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>Support for up to 240 interrupts</dt>
<dd><ul class="first last">
<li>User configurable from 0 to 240</li>
<li>Level sensitive or pulse sensitive</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Support for up to 16 interrupt priority levels</dt>
<dd><ul class="first last">
<li>Programmable from 0 (highest priority) to 15 (lowest priority)</li>
</ul>
</dd>
</dl>
</li>
<li>The priority of each interrupt can be programmed individually by software</li>
<li><dl class="first docutils">
<dt>Interrupt handlers can be preempted by higher-priority interrupts</dt>
<dd><ul class="first last">
<li>Optionally, highest priority level 0 interrupts can be configured as “Fast Interrupts”</li>
<li>Optional second core register bank for use with Fast Interrupts option to minimize interrupt service latency by minimizing the time needed for context saving</li>
</ul>
</dd>
</dl>
</li>
<li>Automatic save and restore of selected registers on interrupt entry and exit for fast context switch</li>
<li>User context saved to user or kernel stack, under program control</li>
<li>Software can set a priority level threshold in STATUS32.E that must be met for an interrupt request to interrupt or wake the processor</li>
<li><dl class="first docutils">
<dt>Minimal interrupt / wake-up logic clocked in sleep state</dt>
<dd><ul class="first last">
<li>Interrupt prioritization logic is purely combinational</li>
</ul>
</dd>
</dl>
</li>
<li>Any Interrupt can be triggered by software</li>
</ul>
<p>The interrupt unit can be programmed by auxiliary registers. For more details, please to refer the DesignWare® ARC® processors ISA.</p>
<ol class="arabic simple" start="3">
<li>Interrupt API in embARC OSP</li>
</ol>
<p>In embARC OSP, A basic exception and interrupt processing framework is implemented in embARC OSP. Through this framework, you can handle specific exceptions or interrupts by installing the desired handlers. This can help you analyze the underlying details of saving and operating registers. Pleas go <a class="reference external" href="http://embarc.org/embarc_osp/doc/build/html/arc/arc.html#arc-hal-exc-int">here</a> for detais.</p>
<p>The interrupt and exception related API are defined in <code class="docutils literal notranslate"><span class="pre">arc_exception.h</span></code>.</p>
</div>
<div class="section" id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="part-i-implement-a-customized-timer0-interrupt-handling">
<h3>Part I: implement a customized timer0 interrupt handling<a class="headerlink" href="#part-i-implement-a-customized-timer0-interrupt-handling" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Build and Run</li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">   $</span> <span class="nb">cd</span> &lt;embarc_root&gt;/arc_labs/labs/lab4_interrupt/part1
<span class="gp">   #</span> <span class="k">for</span> emsk
<span class="gp">   $</span> make <span class="nv">BOARD</span><span class="o">=</span>emsk <span class="nv">BD_VER</span><span class="o">=</span><span class="m">22</span> <span class="nv">CUR_CORE</span><span class="o">=</span>arcem7d <span class="nv">TOOLCHAIN</span><span class="o">=</span>GNU run
<span class="gp">   #</span> <span class="k">for</span> iotdk
<span class="gp">   $</span> make <span class="nv">BOARD</span><span class="o">=</span>emsk <span class="nv">TOOLCHAIN</span><span class="o">=</span>GNU run

<span class="go">2. Output</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">embARC Build Time: Mar 16 2018, 09:58:46</span>
<span class="go">Compiler Version: Metaware, 4.2.1 Compatible Clang 4.0.1</span>

<span class="go">This is an example about timer interrupt</span>
<span class="go">/********TEST MODE START********/</span>
<span class="go">0s</span>

<span class="go">1s</span>

<span class="go">2s</span>

<span class="go">3s</span>

<span class="go">4s</span>

<span class="go">5s</span>

<span class="go">...</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Code analysis</li>
</ol>
<p>The code can be roughly divided into three parts: interrupt service function, main function, and delay function.</p>
<ul class="simple">
<li>Interrupt service function:</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">timer0_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">timer_int_clear</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">);</span>
  <span class="n">t0</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code is a standard example of an interrupt service routine: enters the service function, clears the interrupt flag bit, and then performs the processing that needs to be done in the interrupt service function. Other interrupt service functions can also be written using this template.</p>
<p>In this function, the count variable t0 is incremented by one.</p>
<ul class="simple">
<li>Main function</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
      <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">);</span>

      <span class="n">int_handler_install</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">,</span> <span class="n">timer0_isr</span><span class="p">);</span>
      <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">,</span> <span class="n">INT_PRI_MIN</span><span class="p">);</span>

      <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">This is a example about timer interrupt.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">/******** TEST MODE START ********/</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
      <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">COUNT</span><span class="p">);</span>

      <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
            <span class="n">timer0_delay_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
            <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s"> %ds.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">second</span><span class="p">);</span>
            <span class="n">second</span> <span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">E_SYS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">EMBARC_PRINTF</span></code> function in this code is only used to send information to the computer, which can be ignored during analysis.</p>
<p>This code is divided into two parts: initialization and looping.</p>
<p>In the initialization section, the timer and timer interrupts are configured.</p>
<p>This code uses the embARC OSP API to program <strong>Timer0</strong>. In fact, in essence, these two methods are the same. The API just encapsulates the read and write operations of the auxiliary registers for convenience.</p>
<p><strong>First</strong>, in order to configure <strong>Timer0</strong> and it’s interrupts, turn them off first. This work is done by the functions <code class="docutils literal notranslate"><span class="pre">int_disable</span></code> and <code class="docutils literal notranslate"><span class="pre">timer_stop</span></code>.</p>
<p><strong>Then</strong> configure the interrupt service function and priority for our interrupts. This work is done by the functions <code class="docutils literal notranslate"><span class="pre">int_handler_install</span></code> and <code class="docutils literal notranslate"><span class="pre">int_pri_set</span></code>.</p>
<p><strong>Finally</strong>, after the interrupt configuration is complete, enable the <strong>Timer0</strong> and interrupts that are previously turned off. This work is done by the functions <code class="docutils literal notranslate"><span class="pre">int_enable</span></code> and <code class="docutils literal notranslate"><span class="pre">timer_start</span></code>.
The implementation of the <code class="docutils literal notranslate"><span class="pre">timer_start</span></code> function is the same as the reading and writing of the auxiliary registers in our lab_3. Interested students can view them in the file arc_timer.c. One point to note in this step is the configuration of <code class="docutils literal notranslate"><span class="pre">timer_limit</span></code> (the last parameter of <code class="docutils literal notranslate"><span class="pre">timer_start</span></code>). Configure the interrupt time to 1ms , do a simple calculation (the formula is the expression after COUNT).</p>
<p>In this example, the loop body only serves as an effect display. Our own delay function in the loop body to print the time per second is called.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since nSIM is only simulated by computer, there may be time inaccuracy when using this function. Interested students can use the EMSK to program the program in the development board. In this case, the time is much higher than that in nSIM.</p>
</div>
<ul class="simple">
<li>Delay function</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">timer0_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">t0</span><span class="o">&lt;</span><span class="n">ms</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code is very simple and the idea is clear. When the function entered, clear the global variable t0. The interrupt interval is set to 1ms in the above timer_start, assume that every time t0 is incremented, the time has passed 1ms.</p>
<p>Wait through the while(t0&lt;ms) sentence, so that the full ms delay with higher precision is received.</p>
</div>
<div class="section" id="part-ii-interrupt-priority-and-interrupt-nesting">
<h3>Part II: interrupt priority and interrupt nesting<a class="headerlink" href="#part-ii-interrupt-priority-and-interrupt-nesting" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Build and Run</li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">   $</span> <span class="nb">cd</span> &lt;embarc_root&gt;/arc_labs/labs/lab4_interrupt/part2
<span class="gp">   #</span> <span class="k">for</span> emsk
<span class="gp">   $</span> make <span class="nv">BOARD</span><span class="o">=</span>emsk <span class="nv">BD_VER</span><span class="o">=</span><span class="m">22</span> <span class="nv">CUR_CORE</span><span class="o">=</span>arcem7d <span class="nv">TOOLCHAIN</span><span class="o">=</span>GNU run
<span class="gp">   #</span> <span class="k">for</span> iotdk
<span class="gp">   $</span> make <span class="nv">BOARD</span><span class="o">=</span>emsk <span class="nv">TOOLCHAIN</span><span class="o">=</span>GNU run

<span class="go">2. Output</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">embARC Build Time: Mar 16 2018, 09:58:46</span>
<span class="go">Compiler Version: Metaware, 4.2.1 Compatible Clang 4.0.1</span>

<span class="go">This test will start in 1s.</span>

<span class="go">/********TEST MODE START********/</span>

<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt  nesting!</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt</span>
<span class="go">Interrupt</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Code analysis</li>
</ol>
<p>The code for PART II can be divided into two parts: the interrupt service routine and the main function.</p>
<ul class="simple">
<li>Interrupt service function</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">timer0_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">timer_int_clear</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">);</span>

  <span class="n">timer_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">board_delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">timer_flag</span><span class="p">)</span>
  <span class="p">{</span>
          <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;Interrupt nesting!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
          <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;Interrupt</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">hits</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">timer1_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">timer_int_clear</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">);</span>

  <span class="n">timer_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Through the above code, when timer0’s interrupt comes in and is serviced, its ISR will output different message
according the value of <em>timer_flag</em>, which is only be set in timer1’s ISR <em>timer1_isr</em>. This means timer0’s interrupt is preempted by
timer1’s interrupt as it has a higher interrupt priority.</p>
<p>“Interrupt nesting!” indicates that interrupt nesting has occurred, and “Interrupt” indicates that it has not occurred.</p>
<ul class="simple">
<li>main function</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">);</span>
        <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">);</span>

        <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
        <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">);</span>

        <span class="n">int_handler_install</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">,</span> <span class="n">timer0_isr</span><span class="p">);</span>
        <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">,</span> <span class="n">INT_PRI_MAX</span><span class="p">);</span>

        <span class="n">int_handler_install</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">,</span> <span class="n">timer1_isr</span><span class="p">);</span>
        <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">,</span> <span class="n">INT_PRI_MIN</span><span class="p">);</span>

        <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">The test will start in 1s.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
        <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">);</span>

        <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">MAX_COUNT</span><span class="p">);</span>
        <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">MAX_COUNT</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>

        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">if</span><span class="p">((</span><span class="n">hits</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesting_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">);</span>
                        <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">);</span>

                        <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
                        <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">);</span>

                        <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">,</span> <span class="n">INT_PRI_MIN</span><span class="p">);</span>
                        <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">,</span> <span class="n">INT_PRI_MAX</span><span class="p">);</span>

                        <span class="n">nesting_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                        <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
                        <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">);</span>

                        <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">MAX_COUNT</span><span class="p">);</span>
                        <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">MAX_COUNT</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">hits</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesting_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">);</span>
                        <span class="n">timer_stop</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">);</span>

                        <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
                        <span class="n">int_disable</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">);</span>

                        <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">,</span> <span class="n">INT_PRI_MAX</span><span class="p">);</span>
                        <span class="n">int_pri_set</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">,</span> <span class="n">INT_PRI_MIN</span><span class="p">);</span>

                        <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">nesting_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER0</span><span class="p">);</span>
                        <span class="n">int_enable</span><span class="p">(</span><span class="n">INTNO_TIMER1</span><span class="p">);</span>

                        <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_0</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">MAX_COUNT</span><span class="p">);</span>
                        <span class="n">timer_start</span><span class="p">(</span><span class="n">TIMER_1</span><span class="p">,</span> <span class="n">TIMER_CTRL_IE</span> <span class="o">|</span> <span class="n">TIMER_CTRL_NH</span><span class="p">,</span> <span class="n">MAX_COUNT</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">E_SYS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>First, the timer 0 and timer 1 are configured and install with corresponding ISR. Then in the while loop, the interrupt priority of timer 0 and timer 1 are periodically changed to make the interrupt nesting happen.</p>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p>Try using an interrupt other than a timer to write a small program. (For example, try to implement a button controlled LED using GPIO interrupt)</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab6.html" class="btn btn-neutral float-right" title="A simple bootloader" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab3.html" class="btn btn-neutral" title="ARC features: AUX registers and timers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Synopsys

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>