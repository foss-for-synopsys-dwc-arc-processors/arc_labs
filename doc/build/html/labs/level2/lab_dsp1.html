

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ARC DSP: Compiler Optimizations &mdash; ARC Labs 2018.09 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ARC DSP: Using FXAPI" href="lab_dsp2.html" />
    <link rel="prev" title="How to use FreeRTOS" href="lab9.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ARC Labs
          

          
          </a>

          
            
            
              <div class="version">
                2018.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../labs.html">Hands-on labs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../level1.html">Basic labs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../level2.html">Advanced labs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lab8.html">Memory map and linker</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab10.html">A WiFi temperature monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab7.html">BLE Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab9.html">How to use FreeRTOS</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ARC DSP: Compiler Optimizations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#content">Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#principles">Principles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps">Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lab_dsp2.html">ARC DSP: Using FXAPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab_dsp3.html">ARC DSP: Using DSP Library</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../level3.html">Exploration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC Labs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../labs.html">Hands-on labs</a> &raquo;</li>
        
          <li><a href="../level2.html">Advanced labs</a> &raquo;</li>
        
      <li>ARC DSP: Compiler Optimizations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/labs/level2/lab_dsp1.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arc-dsp-compiler-optimizations">
<span id="lab-dsp1"></span><h1>ARC DSP: Compiler Optimizations<a class="headerlink" href="#arc-dsp-compiler-optimizations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>To understand Metaware compiler DSP extension options and optimization level</li>
<li>To learn how to use Metaware compiler to optimize regular C code with DSP instructions</li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The following hardware and tools are required:</p>
<ul class="simple">
<li>PC host</li>
<li>MetaWare Development Toolkit</li>
<li>ARC board (EM Starter Kit / IoT Development Kit)</li>
<li><code class="docutils literal notranslate"><span class="pre">embarc_osp/arc_labs/labs/dsp_lab_compiler_opt</span></code></li>
</ul>
</div>
<div class="section" id="content">
<h2>Content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h2>
<p>An example code below contains a function “test” which contains a 20 step for loop and a multiply accumulate operation done manually.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">short</span> <span class="nf">test</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="kt">long</span> <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">acc</span> <span class="o">+=</span> <span class="p">(</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="n">a</span><span class="o">++</span><span class="p">))</span> <span class="o">*</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span><span class="mi">1</span> <span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">acc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="n">a</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">};</span>
<span class="kt">short</span> <span class="n">b</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">short</span> <span class="n">c</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;result=%d&quot;</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use Metaware compiler to optimize the C code with and without DSP extension options, and analyze the assembly code.</p>
</div>
<div class="section" id="principles">
<h2>Principles<a class="headerlink" href="#principles" title="Permalink to this headline">¶</a></h2>
<p>This section describes compiler options in MetaWare used in this lab.</p>
<p>To optimize code with DSP extensions, two sets of compiler options are used throughout the lab: DSP Extensions options and optimization level.</p>
<div class="section" id="dsp-extensions-options">
<h3>DSP Extensions Options<a class="headerlink" href="#dsp-extensions-options" title="Permalink to this headline">¶</a></h3>
<p>Use embARC OSP build system to compile the code. The details can be found in embARC OSP document page. Here is the example command. You can pass extra compiler/liner options by ADT_COPT/ADT_LOPT.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">gmake BOARD=iotdk BD_VER=10 CUR_CORE=arcem9d TOOLCHAIN=mw ADT_COPT=&quot;-Hfxapi -Xdsp2&quot; OLEVEL=O2</span>
</pre></div>
</div>
<p>Options that are used in the lab are:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Xdsp[1/2]</span></code>:</p>
<p>Enable DSP instructions</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Xdsp_complex,</span> <span class="pre">-Xdsp_divsqrt</span></code>:</p>
<p>Enable complex arithmetic DSP, divide, and sqrt instructions</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Xdsp_ctrl[=up|convergent,noguard|guard,</span> <span class="pre">preshift|postshift]</span></code>:</p>
<p>Fine-tune the compiler’s assumptions about the rounding, guard-bit, and fractional product shift behavior</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Hdsplib</span></code>: Link in the DSP library</p>
<p>For programming ARC fixed-point DSP in C and C++</p>
<p>Contains functions to carry out DSP algorithms such as filtering and transforms</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Hfxapi</span></code>: Use the Fixed Point API support library</p>
<p>Used with <code class="docutils literal notranslate"><span class="pre">-Xdsp</span></code>. Provides low level intrinsic support for ARC EM DSP instructions.</p>
<p>Programs written using this API execute natively on an ARC EM processor with DSP extensions and can also be emulated on x86 Windows hosts.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Xxy</span></code>: Specifies that XY memory is available</p>
<p>Used with <code class="docutils literal notranslate"><span class="pre">-Xdsp2</span></code>. Enables optimization for XY memory</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">-Xagu_small,</span> <span class="pre">-Xagu_medium,</span> <span class="pre">-Xagu_large</span></code>:</p>
<p>Enables AGU, and specifies its size.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because ARC is configurable processor, different cores can contain different extensions on hardware level. Therefore, options set for compiler should match underlying hardware. On the other hand, if specific hardware feature is present in the core but compiler option is not set, it cannot be used effectively, if used at all. IOTDK Core default options are presented in tcf file.</p>
</div>
</div>
<div class="section" id="optimization-level">
<h3>Optimization level<a class="headerlink" href="#optimization-level" title="Permalink to this headline">¶</a></h3>
<p>MetaWare compiler has different optimization levels, which enables or disables various optimization techniques included in the compiler. You can pass the optimization option to gmake by “OLEVEL=O2”.</p>
<p>The lowest level is the default -O0, which does little optimization to the compiled assembly code, which can be used for debugging, because in un-optimized assembly code all source code commands have 1:1 representation. On the other hand, -O3 highest level optimization highly modifies output assembly code to make it smaller and fast, but debugging such a code is harder, because it is not close match with source code. Also, high level of optimization requires longer compilation time, which for large project can be significant, if many compilation iterations are to be made.</p>
</div>
<div class="section" id="optimization-for-dsp-extensions">
<h3>Optimization for DSP extensions<a class="headerlink" href="#optimization-for-dsp-extensions" title="Permalink to this headline">¶</a></h3>
<p>A regular code without direct usage of DSP extensions can be optimized to use DSP extensions wherever applicable, which compiler can do automatically with DSP extension options corresponding to hardware are set and high-level of optimization is selected.</p>
</div>
</div>
<div class="section" id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="compiling-with-option-o0-dsp-extensions-will-be-specified-in-tcf-file">
<h3>1. Compiling with option -O0, DSP extensions will be specified in TCF file<a class="headerlink" href="#compiling-with-option-o0-dsp-extensions-will-be-specified-in-tcf-file" title="Permalink to this headline">¶</a></h3>
<p>Below is the list of options used when launching gmake:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">OLEVEL=O0</span></code></p>
<p>You can use the following command to generate disassembly code, and check assembly code for function “test”.</p>
<p><code class="docutils literal notranslate"><span class="pre">elfdump</span> <span class="pre">-T</span> <span class="pre">-S</span> <span class="pre">&lt;your_working_directory&gt;/obj_iotdk_10/mw_arcem9d/dsp_lab1_mw_arcem9d.elf</span></code></p>
<p>Notice assembly code in the disassembled output. See how many assembly instruction are used for each line. For example, for loop spends several instruction to calculate loop variable value and check whether to stop.</p>
<p><img alt="dsp_figure_1.1" src="../../_images/dsp_figure_1.1.png" /></p>
</div>
<div class="section" id="compiling-with-dsp-extensions-with-o2">
<h3>2. Compiling with DSP extensions, with -O2<a class="headerlink" href="#compiling-with-dsp-extensions-with-o2" title="Permalink to this headline">¶</a></h3>
<p>Compile with:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">OLEVEL=O2</span></code></p>
<p>Adding optimization level -O2, optimizes out many of the instructions:</p>
<p><img alt="dsp_figure_1.2" src="../../_images/dsp_figure_1.2.png" /></p>
<p>In this code it is easy to find zero-delay loop (“lp” command) which acts as for loop. Note that multiply-accumulate is done with separate “mpyw_s” and “add1_s” instructions.</p>
</div>
<div class="section" id="compiling-with-dsp-extensions-with-o3">
<h3>3. Compiling with DSP extensions, with -O3<a class="headerlink" href="#compiling-with-dsp-extensions-with-o3" title="Permalink to this headline">¶</a></h3>
<p>Compile with:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">OLEVEL=O3</span></code></p>
<p>Adding -Xdsp1 (optimization level changed to -O3) helps compiler to optimize away “mpyw_s” and “add1_s” instructions and replace them with hardware dual-16bit SIMD multilication “vmpy2h”. Notice the loop count is now 5.</p>
<p><img alt="dsp_figure_1.3" src="../../_images/dsp_figure_1.3.png" /></p>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p>Remove “&lt;&lt;1” from test function and see changes in the output instructions.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab_dsp2.html" class="btn btn-neutral float-right" title="ARC DSP: Using FXAPI" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab9.html" class="btn btn-neutral" title="How to use FreeRTOS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Synopsys

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>