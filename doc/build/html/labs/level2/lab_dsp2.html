

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ARC DSP: Using FXAPI &mdash; ARC Labs 2018.09 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ARC DSP: Using DSP Library" href="lab_dsp3.html" />
    <link rel="prev" title="ARC DSP: Compiler Optimizations" href="lab_dsp1.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ARC Labs
          

          
          </a>

          
            
            
              <div class="version">
                2018.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../labs.html">Hands-on labs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../level1.html">Basic labs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../level2.html">Advanced labs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lab8.html">Memory map and linker</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab10.html">A WiFi temperature monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab7.html">BLE Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab9.html">How to use FreeRTOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab_dsp1.html">ARC DSP: Compiler Optimizations</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ARC DSP: Using FXAPI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#content">Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#principle">Principle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps">Steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lab_dsp3.html">ARC DSP: Using DSP Library</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../level3.html">Exploration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC Labs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../labs.html">Hands-on labs</a> &raquo;</li>
        
          <li><a href="../level2.html">Advanced labs</a> &raquo;</li>
        
      <li>ARC DSP: Using FXAPI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/labs/level2/lab_dsp2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arc-dsp-using-fxapi">
<span id="lab-dsp2"></span><h1>ARC DSP: Using FXAPI<a class="headerlink" href="#arc-dsp-using-fxapi" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>To understand what is ARC Fixed-point API (FXAPI)</li>
<li>To learn how to use FXAPI to optimize DSP programs</li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The following hardware and tools are required:</p>
<ul class="simple">
<li>PC host</li>
<li>MetaWare Development Toolkit</li>
<li>ARC board (EM Starter Kit / IoT Development Kit)</li>
<li><code class="docutils literal notranslate"><span class="pre">embarc_osp/arc_labs/labs/dsp_lab_fxapi</span></code></li>
</ul>
</div>
<div class="section" id="content">
<h2>Content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h2>
<p>This lab uses complex number multiplication as an example where using just compiler optimization options cannot gain the same effect as calling DSP instructions manually through FXAPI.</p>
</div>
<div class="section" id="principle">
<h2>Principle<a class="headerlink" href="#principle" title="Permalink to this headline">¶</a></h2>
<p>In this lab two implementations of complex multiplication are shown with and without FXAPI.</p>
<div class="section" id="complex-number-multiplication">
<h3>Complex number multiplication<a class="headerlink" href="#complex-number-multiplication" title="Permalink to this headline">¶</a></h3>
<p>Multiplication of two complex numbers
<img alt="dsp_icon_2.1" src="../../_images/dsp_icon_2.1.png" />
and
<img alt="dsp_icon_2.2" src="../../_images/dsp_icon_2.2.png" /></p>
<p>Is done using formula:</p>
<p><img alt="dsp_icon_2.3" src="../../_images/dsp_icon_2.3.png" /></p>
<p>In this lab example multiplication and accumulation of two arrays of complex numbers are used as a way to compare performance of ARC DSP extensions when used effectively.</p>
<p>The sum of element wise products of two arrays of complex numbers is calculated according to the following formula:</p>
<p><img alt="dsp_icon_2.4" src="../../_images/dsp_icon_2.4.png" /></p>
<p>where a and b are arrays of N complex numbers.</p>
</div>
<div class="section" id="implementation-without-dsp">
<h3>Implementation without DSP<a class="headerlink" href="#implementation-without-dsp" title="Permalink to this headline">¶</a></h3>
<p>In order to calculate element wise products of two arrays of complex numbers, a struct can be defined that stores real and imaginary parts of the complex number. Therefore, the calculation process receives an array of structures and works on it. The code is shown below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">short</span> <span class="n">real</span><span class="p">;</span> <span class="kt">short</span> <span class="n">imag</span><span class="p">;</span> <span class="p">}</span> <span class="n">complex_short</span><span class="p">;</span>

<span class="n">complex_short</span> <span class="nf">short_complex_array_mult</span> <span class="p">(</span><span class="n">complex_short</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">complex_short</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">complex_short</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">acci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">accr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">accr</span>  <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">real</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">real</span> <span class="p">);</span>
            <span class="n">accr</span>  <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">imag</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">imag</span> <span class="p">);</span>

            <span class="n">acci</span>  <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">real</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">imag</span> <span class="p">);</span>
            <span class="n">acci</span>  <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">imag</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">real</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">result</span><span class="p">.</span><span class="n">real</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="n">accr</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">imag</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="n">acci</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example keeps real and imaginary values in variables of type “short”, while multiplication results are kept in “int” integer to avoid truncation. Final result is casted to short to return complex number as a result.</p>
</div>
<div class="section" id="implementation-with-fxapi">
<h3>Implementation with FXAPI<a class="headerlink" href="#implementation-with-fxapi" title="Permalink to this headline">¶</a></h3>
<p>FXAPI makes it possible to directly access complex number instructions (like MAC) available in ARC DSP Extensions. This is done through complex number type cq15_t, and various fx_* functions. Here <code class="docutils literal notranslate"><span class="pre">fx_v2a40_cmac_cq15</span></code> FXAPI function is called which performs MAC of two cq15_t complex numbers.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">cq15_t</span> <span class="nf">fx_complex_array_mult</span><span class="p">(</span><span class="n">cq15_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">cq15_t</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">v2accum40_t</span> <span class="n">acc</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">acc</span> <span class="o">=</span> <span class="n">fx_v2a40_cmac_cq15</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">fx_cq15_cast_v2a40</span><span class="p">(</span> <span class="n">acc</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As with previous implementation <code class="docutils literal notranslate"><span class="pre">q15_t</span></code> is of similar size as <code class="docutils literal notranslate"><span class="pre">short</span></code> type, therefore, multiplication result needs larger storage. Here 40b vector accumulator is used directly to store intermediate results of MAC, and is casted to <code class="docutils literal notranslate"><span class="pre">cq15_t</span></code> on return.</p>
</div>
<div class="section" id="using-iotdk-board-for-performance-comparison">
<h3>Using IoT Development Kit board for performance comparison<a class="headerlink" href="#using-iotdk-board-for-performance-comparison" title="Permalink to this headline">¶</a></h3>
<p>To compare performance of these two functions a simple application is created that performs complex array multiplication using either of the implementations above. The program initializes two arrays of complex numbers with random values and calls functions above in a loop (1 000 000-10 000 000 times) to make calculation delay measurable in seconds. This is done 8 times, and after each loop a LED on board turns-on. In the result, LED strip on board works as a “progress bar” showing the process of looped multiplications.</p>
<p>The main performance check loop is shown in the following example. The outer loop runs 8 times (number of LEDs on LED strip), the inner loop makes “LOOPS/8” calls to complex multiplication function. LOOPS variable is configurable to change the total delay.</p>
</div>
</div>
<div class="section" id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<p>To test the following example, some modification of the code is required to have two loops with and without DSP. You must re-build libraries for this particular configuration of IOTDK:</p>
<p><code class="docutils literal notranslate"><span class="pre">buildlib</span> <span class="pre">my_dsp</span> <span class="pre">-tcf=&lt;IOTDK</span> <span class="pre">tcf</span> <span class="pre">file&gt;</span> <span class="pre">-bd</span> <span class="pre">.</span> <span class="pre">-f</span></code></p>
<p>IoT Development Kit tcf file can be found in <code class="docutils literal notranslate"><span class="pre">embarc_osp/board/iotdk/configs/10/tcf/arcem9d.tcf</span></code></p>
<p>Both examples are to be compiled with DSP extensions.</p>
<div class="section" id="step-1-run-program-without-fxapi">
<h3>Step 1. Run program without FXAPI<a class="headerlink" href="#step-1-run-program-without-fxapi" title="Permalink to this headline">¶</a></h3>
<p>Build with the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">ADT_COPT=&quot;-Hdsplib</span> <span class="pre">-Xdsp2</span> <span class="pre">-tcf=./arcem9d.tcf</span></code></p>
<blockquote>
<div><code class="docutils literal notranslate"><span class="pre">-Xdsp_complex&quot;</span> <span class="pre">ADT_LOPT=&quot;-Hdsplib</span> <span class="pre">-Xdsp2</span> <span class="pre">-tcf=./arcem9d.tcf</span> <span class="pre">-Hlib=./my_dsp&quot;</span></code></div></blockquote>
<p>With high optimization level functions using “short” type is compiled to use DSP MAC operation, enabling significant speedup.</p>
<p><img alt="dsp_figure_2.1" src="../../_images/dsp_figure_2.1.png" /></p>
</div>
<div class="section" id="step-2-run-program-with-fxapi">
<h3>Step 2. Run program with FXAPI<a class="headerlink" href="#step-2-run-program-with-fxapi" title="Permalink to this headline">¶</a></h3>
<p>Rename main.c.fxapi to main.c, then execute the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">ADT_COPT=&quot;-Hdsplib</span> <span class="pre">-Xdsp2</span> <span class="pre">-tcf=./arcem9d.tcf</span></code></p>
<blockquote>
<div><code class="docutils literal notranslate"><span class="pre">-Xdsp_complex&quot;</span> <span class="pre">ADT_LOPT=&quot;-Hdsplib</span> <span class="pre">-Xdsp2</span> <span class="pre">-tcf=./arcem9d.tcf</span> <span class="pre">-Hlib=./my_dsp&quot;</span></code></div></blockquote>
<p>However, using FXAPI enables compiler to directly use complex MAC instruction “cmachfr”.</p>
<p><img alt="dsp_figure_2.2" src="../../_images/dsp_figure_2.2.png" /></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab_dsp3.html" class="btn btn-neutral float-right" title="ARC DSP: Using DSP Library" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab_dsp1.html" class="btn btn-neutral" title="ARC DSP: Compiler Optimizations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Synopsys

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>