

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ARC DSP: Using DSP Library &mdash; ARC Labs 2018.09 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Exploration" href="../level3.html" />
    <link rel="prev" title="ARC DSP: Using FXAPI" href="lab_dsp2.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ARC Labs
          

          
          </a>

          
            
            
              <div class="version">
                2018.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../labs.html">Hands-on labs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../level1.html">Basic labs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../level2.html">Advanced labs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lab8.html">Memory map and linker</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab10.html">A WiFi temperature monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab7.html">BLE Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab9.html">How to use FreeRTOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab_dsp1.html">ARC DSP: Compiler Optimizations</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab_dsp2.html">ARC DSP: Using FXAPI</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ARC DSP: Using DSP Library</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#content">Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#principle">Principle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps">Steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../level3.html">Exploration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC Labs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../labs.html">Hands-on labs</a> &raquo;</li>
        
          <li><a href="../level2.html">Advanced labs</a> &raquo;</li>
        
      <li>ARC DSP: Using DSP Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/labs/level2/lab_dsp3.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arc-dsp-using-dsp-library">
<span id="lab-dsp3"></span><h1>ARC DSP: Using DSP Library<a class="headerlink" href="#arc-dsp-using-dsp-library" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>To understand what is ARC DSP library</li>
<li>To learn how to use DSP library to optimize DSP programs</li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The following hardware and tools are required:</p>
<ul class="simple">
<li>PC host</li>
<li>MetaWare Development Toolkit</li>
<li>ARC board (EM Starter Kit / IoT Development Kit)</li>
<li><code class="docutils literal notranslate"><span class="pre">embarc_osp/arc_labs/labs/dsp_lab_dsp_lib</span></code></li>
</ul>
</div>
<div class="section" id="content">
<h2>Content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h2>
<p>This lab uses matrix multiplication as an example where DSP library helps to efficiently use DSP extensions with shorter code.
Use DSP Library and compare program run speed with and without DSP library.</p>
</div>
<div class="section" id="principle">
<h2>Principle<a class="headerlink" href="#principle" title="Permalink to this headline">¶</a></h2>
<p>In this lab two implementations of matrix multiplication are shown: implemented manually and with the use of DSP library.</p>
<div class="section" id="matrix-multiplication">
<h3>Matrix multiplication<a class="headerlink" href="#matrix-multiplication" title="Permalink to this headline">¶</a></h3>
<p>Multiplication of two matrices A and B of sizes [M*N] and [N*K] respectively is implemented using the following formula:</p>
<p><img alt="dsp_icon_3.1" src="../../_images/dsp_icon_3.1.png" /></p>
<p>Where i= 0…(M-1) and j = 0..(K-1) are row and column indexes of output matrix, with size [M*K].</p>
</div>
<div class="section" id="implementation-without-dsp">
<h3>Implementation without DSP<a class="headerlink" href="#implementation-without-dsp" title="Permalink to this headline">¶</a></h3>
<p>The following example shows the implementation of matrix multiplication of two matrices containing “short” values. By convention, matrices here are implemented as 1D arrays with row-first indexing, where element a_ik is indexed as
<img alt="dsp_icon_3.2" src="../../_images/dsp_icon_3.2.png" /></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;embARC.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;embARC_debug.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#define MATRIX_SIZE 20</span>
<span class="cp">#define MAX_NUM 1000</span>
<span class="cp">#define LOOPS 100000</span>

<span class="cm">/* ********************************************* */</span>

<span class="cm">/* Matrix manipulation functions */</span>

<span class="cm">/* randomize matrix with values up to &#39;max_value */</span>
<span class="kt">void</span> <span class="nf">rand_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_value</span><span class="p">)</span> <span class="p">;</span>

<span class="cm">/* multiply two square matrices of same size*/</span>
<span class="kt">void</span> <span class="nf">mul_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">short</span> <span class="n">y</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">short</span> <span class="n">z</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">;</span>

<span class="cm">/* print square matrix through UART*/</span>
<span class="kt">void</span> <span class="nf">print_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="p">);</span>

<span class="cm">/* ********************************************* */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">short</span> <span class="n">a</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="p">][</span><span class="n">MATRIX_SIZE</span><span class="p">];</span>
    <span class="kt">short</span> <span class="n">b</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="p">][</span><span class="n">MATRIX_SIZE</span><span class="p">];</span>
    <span class="kt">short</span> <span class="n">c</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="p">][</span><span class="n">MATRIX_SIZE</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span><span class="n">MATRIX_SIZE</span><span class="p">;</span>

    <span class="n">rand_sq_mat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">MAX_NUM</span><span class="p">);</span>
    <span class="n">rand_sq_mat</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">MAX_NUM</span><span class="p">);</span>

    <span class="n">print_sq_mat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
    <span class="n">print_sq_mat</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_status</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="p">;</span>
    <span class="n">led_status</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;*** Start ***</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">LOOPS</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">mul_sq_mat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="n">led_write</span><span class="p">(</span><span class="n">led_status</span><span class="p">,</span> <span class="n">BOARD_LED_MASK</span><span class="p">);</span>
            <span class="n">led_status</span> <span class="o">=</span> <span class="n">led_status</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">print_sq_mat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;*** Exit ***</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">rand_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">SIZE</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">max_value</span><span class="p">);</span> <span class="c1">//plus 1 to avoid zeros</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mul_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span><span class="kt">short</span> <span class="n">y</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">short</span> <span class="n">z</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
                    <span class="p">}</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="p">][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="p">){</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;------</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\r</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;------</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="implementation-with-dsplib">
<h3>Implementation with DSPLIB<a class="headerlink" href="#implementation-with-dsplib" title="Permalink to this headline">¶</a></h3>
<p>DSP library contains matrix multiplication function, implementing matrix multiplication using DSP library requires initialization of matrix arrays (1D) and call to <code class="docutils literal notranslate"><span class="pre">dsp_mat_mult_q15</span></code>. The overall code is 4 lines, as highlighted in the following code. Note that dsplib.h must be included, and matrix a, b, and c must be declared as global variable. As the numbers are in q15 type, it is better to make elements of a and b between 32767 (~0.99) and 16384 (0.5), or 32768(-1) and 49152 (-0.5) that the result in c is not rounded to zero. Note as IOTDK is configured to have small AGU, the DSP library routine is not significantly faster.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;embARC.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;embARC_debug.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;dsplib.h&quot;</span><span class="cp"></span>

<span class="cp">#define MATRIX_SIZE 20</span>
<span class="cp">#define MAX_NUM 1000</span>
<span class="cp">#define LOOPS 100000</span>

<span class="cm">/* ********************************************* */</span>

<span class="cm">/* Matrix manipulation functions */</span>

<span class="cm">/* randomize matrix with values up to &#39;max_value */</span>
<span class="c1">//void rand_sq_mat(short x[][MATRIX_SIZE], int SIZE, int max_value) ;</span>

<span class="cm">/* multiply two square matrices of same size*/</span>
<span class="kt">void</span> <span class="nf">mul_sq_mat</span><span class="p">(</span><span class="kt">short</span> <span class="n">x</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">short</span> <span class="n">y</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">short</span> <span class="n">z</span><span class="p">[][</span><span class="n">MATRIX_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">;</span>

<span class="cm">/* print square matrix through UART*/</span>
<span class="kt">void</span> <span class="nf">print_sq_mat</span><span class="p">(</span><span class="kt">short</span><span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="p">);</span>

<span class="cm">/* ********************************************* */</span>
    <span class="n">__xy</span> <span class="n">q15_t</span> <span class="n">a</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="o">*</span><span class="n">MATRIX_SIZE</span><span class="p">];</span>
    <span class="n">__xy</span> <span class="n">q15_t</span> <span class="n">b</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="o">*</span><span class="n">MATRIX_SIZE</span><span class="p">];</span>
    <span class="n">__xy</span> <span class="n">q15_t</span> <span class="n">c</span><span class="p">[</span><span class="n">MATRIX_SIZE</span><span class="o">*</span><span class="n">MATRIX_SIZE</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span><span class="n">MATRIX_SIZE</span><span class="p">;</span>
<span class="n">matrix_q15_t</span> <span class="n">matA</span><span class="p">,</span> <span class="n">matB</span><span class="p">,</span> <span class="n">matC</span><span class="p">;</span>

    <span class="c1">//rand_sq_mat(a,n, MAX_NUM);</span>
    <span class="c1">//rand_sq_mat(b,n, MAX_NUM);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">MATRIX_SIZE</span><span class="o">*</span><span class="n">MATRIX_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">16384</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">MATRIX_SIZE</span><span class="o">*</span><span class="n">MATRIX_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">16383</span><span class="p">;</span> <span class="p">}</span>


    <span class="n">print_sq_mat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
    <span class="n">print_sq_mat</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

<span class="n">dsp_mat_init_q15</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matA</span><span class="p">,</span>  <span class="n">MATRIX_SIZE</span><span class="p">,</span> <span class="n">MATRIX_SIZE</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="n">dsp_mat_init_q15</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matB</span><span class="p">,</span>  <span class="n">MATRIX_SIZE</span><span class="p">,</span> <span class="n">MATRIX_SIZE</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="n">dsp_mat_init_q15</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matC</span><span class="p">,</span>  <span class="n">MATRIX_SIZE</span><span class="p">,</span> <span class="n">MATRIX_SIZE</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="n">dsp_status</span> <span class="n">status</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_status</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="p">;</span>
    <span class="n">led_status</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;*** Start ***</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">LOOPS</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">dsp_mat_mult_q15</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matC</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="n">led_write</span><span class="p">(</span><span class="n">led_status</span><span class="p">,</span> <span class="n">BOARD_LED_MASK</span><span class="p">);</span>
            <span class="n">led_status</span> <span class="o">=</span> <span class="n">led_status</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">==</span> <span class="n">DSP_ERR_OK</span> <span class="p">)</span> <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;something wrong&quot;</span><span class="p">);</span>
    <span class="n">print_sq_mat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;*** Exit ***</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="c1">//void rand_sq_mat(short x[][MATRIX_SIZE], int SIZE, int max_value) {</span>
<span class="c1">//  for (int i=0;i&lt;SIZE;i++) {</span>
<span class="c1">//          for(int j=0;j&lt;SIZE;j++) {</span>
<span class="c1">//                  x[i][j] = 1 + (rand() % max_value); //plus 1 to avoid zeros</span>
<span class="c1">//          }</span>
<span class="c1">//  }</span>
<span class="c1">//}</span>
<span class="c1">//</span>
<span class="c1">//void mul_sq_mat(short x[][MATRIX_SIZE],short y[][MATRIX_SIZE], short z[][MATRIX_SIZE], int size) {</span>
<span class="c1">//  for (int i=0; i&lt;size; i++) {</span>
<span class="c1">//          for(int j=0;j&lt;size;j++) {</span>
<span class="c1">//                  z[i][j]=0;</span>
<span class="c1">//                  for(int k=0;k&lt;size;k++) {</span>
<span class="c1">//                          z[i][j] += x[i][k]*y[k][j];</span>
<span class="c1">//                  }</span>
<span class="c1">//          }</span>
<span class="c1">//  }</span>
<span class="c1">//}</span>

<span class="kt">void</span> <span class="nf">print_sq_mat</span><span class="p">(</span><span class="kt">short</span><span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="p">){</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;------</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">SIZE</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\r</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EMBARC_PRINTF</span><span class="p">(</span><span class="s">&quot;------</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="using-iotdk-board-for-performance-comparison">
<h3>Using IoT Development Kit board for performance comparison<a class="headerlink" href="#using-iotdk-board-for-performance-comparison" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Create an IoT Development Kit application that uses LED strip as progress bar for large number of matrix multiplications with and without DSP library, adjust number of loops made to achieve measurable delay. Run the example and compare computational delay with and without DSPLIB.</p>
</div>
</div>
</div>
<div class="section" id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<p>Firstly you must build DSP libraries for this particular configuration of IOTDK:</p>
<p><code class="docutils literal notranslate"><span class="pre">buildlib</span> <span class="pre">my_dsp</span> <span class="pre">-tcf=&lt;IOTDK</span> <span class="pre">tcf</span> <span class="pre">file&gt;</span> <span class="pre">-bd</span> <span class="pre">../</span> <span class="pre">-f</span></code></p>
<p>IoT Development Kit tcf file can be found in <code class="docutils literal notranslate"><span class="pre">embarc_osp/board/iotdk/configs/10/tcf/arcem9d.tcf</span></code></p>
<p>Both examples are to be compiled with DSP extensions.</p>
<div class="section" id="run-program-without-dsp-library">
<h3>1. Run program without DSP library<a class="headerlink" href="#run-program-without-dsp-library" title="Permalink to this headline">¶</a></h3>
<p>Build with the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">ADT_COPT=&quot;-Hdsplib&quot;</span> <span class="pre">ADT_LOPT=&quot;-Hdsplib</span> <span class="pre">-Hlib=../my_dsp&quot;</span></code></p>
</div>
<div class="section" id="run-program-with-dsp-library">
<h3>2. Run program with DSP library<a class="headerlink" href="#run-program-with-dsp-library" title="Permalink to this headline">¶</a></h3>
<p>Rename main.c.dsplib to main.c, then execute the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">gmake</span> <span class="pre">BOARD=iotdk</span> <span class="pre">BD_VER=10</span> <span class="pre">CUR_CORE=arcem9d</span> <span class="pre">TOOLCHAIN=mw</span> <span class="pre">ADT_COPT=&quot;-Hdsplib&quot;</span> <span class="pre">ADT_LOPT=&quot;-Hdsplib</span> <span class="pre">-Hlib=../my_dsp&quot;</span></code></p>
<p>Note that DSPLIB is statically linked with the project when -Hdsplib is set, and as the DSPLIB itself is pre-compiled with high level of optimization, changing optimization option for example program does not affect DSPLIB performance. On the other hand, even with highest optimization level a function utilizing simple instructions on “short” type (even converted to MACs if possible) is less efficient that direct use of DSPLIB.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../level3.html" class="btn btn-neutral float-right" title="Exploration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab_dsp2.html" class="btn btn-neutral" title="ARC DSP: Using FXAPI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Synopsys

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>